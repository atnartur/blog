---
title: Решение проблем с ограничением по количеству файлов (inodes)
date: 2016-10-21 21:55:42
tags:
- сервер
- linux
category:
- О разработке
---

Около месяца мы боролись с тем, что на сервере постоянно кончаются inodes (по-русски: иноды или айноды). Это индексные дескрипторы файлов. Одна айнода соответствует одному файлу на сервере. В ней хранится некоторая метаинформация, кроме названия и пути к файлу. Подробнее о нашей проблеме - ниже. 

<!--more-->

Поиск проблемы осложняется тем, что линукс постоянно заявляет, что `no space left on device`. Но по факту место на самом деле есть (в нашем случае около 5 гигов), но места все равно нет. Значит надо смотреть айноды.

`df -h` - посмотреть информацию о занятом пространстве на жестком диске
`df -i` - посмотреть информацию об айнодах

Первоначально я пытался просто удалять некоторые папки, которые содержат очень много файлов. Я считал, что здесь нет никакой проблемы, просто файлов с логами стало слишком много, и их надо немного почистить. Однако освобожденные 55000 айнод забились через 3 дня. 

*Вечер понедельника*
![](/content/2016/10/inodes-problems/1.png)

*Утро четверга*
![](/content/2016/10/inodes-problems/2.png)

Это было очень странно. В результате было принято логичное решение найти в системе такую папку, где очень много непонятных файлов.

Чтобы построить дерево всех каталогов и файлов, выполняем команду: 

```
tree / > dirs.txt
```

Команду нужно выполнить с root-правами для того, чтобы в выдачу попали все каталоги системы. Если утилита tree не установлена, устаналиваем ее из репозиторией, например так: `apt-get install tree`.

В нашем случае сгенерировался файл на 73МБ. После его анализа была найдена папка, в которой скопилось очень много файлов. Для упрощения поиска полного пути до папки, выполняем команду 

```
du -h / > dirs.txt
```

Она покажет нам вес каждой папки и полный путь до нее. Опять же, команда должна выполняться с root-правами.

После того, как был найден полный путь до папки, выяснилось, что в ней содержатся **1098902 файлов** на 231 МБ. В получении этих данных помогли команды:

`du -h .` - подсчет размера текущей папки
`ls -f . | wc -l` - подсчет количества файлов в текущей папке

Теперь начинаем удалять файлы с помощью

```
rm /path/to/dir -rf
```

где `/path/to/dir` - путь до проблемной папки.

После этих операций количество свободных айнод перевалило за миллион. Победа!
![](/content/2016/10/inodes-problems/3.png)

*Спасибо [Андрею Романову](https://vk.com/romanovandreey) за помощь в решении проблем!*

